name: Blue/Green Deploy

on:
  workflow_dispatch:
    inputs:
      image_digest:
        description: 'Image digest to deploy (sha256:...)'
        required: true
        type: string
      target_slot:
        description: 'Target slot (auto-detects inactive slot if empty)'
        required: false
        type: choice
        options: ['', blue, green]
      smoke_test_timeout:
        description: 'Smoke test timeout in seconds'
        required: false
        default: '120'
        type: string
      skip_migration_check:
        description: 'Skip DB migration compatibility check'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: blue-green-deploy
  cancel-in-progress: false

env:
  REGISTRY: ${{ secrets.REGISTRY_URL || 'ghcr.io' }}
  IMAGE_NAME: ${{ github.repository }}

jobs:
  preflight:
    name: Pre-Flight Checks
    runs-on: ubuntu-latest
    outputs:
      active_slot: ${{ steps.detect.outputs.active }}
      inactive_slot: ${{ steps.detect.outputs.inactive }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Verify image signature
        run: |
          chmod +x tools/verify-image.sh
          bash tools/verify-image.sh \
            "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ github.event.inputs.image_digest }}"

      - name: Detect active/inactive slots
        id: detect
        run: |
          TARGET="${{ github.event.inputs.target_slot }}"

          if [ -n "$TARGET" ]; then
            if [ "$TARGET" = "blue" ]; then
              ACTIVE="green"
              INACTIVE="blue"
            else
              ACTIVE="blue"
              INACTIVE="green"
            fi
          else
            # Auto-detect: check which slot is currently serving production traffic
            BLUE_EXISTS=$(docker manifest inspect "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:blue" 2>/dev/null && echo "yes" || echo "no")
            GREEN_EXISTS=$(docker manifest inspect "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:green" 2>/dev/null && echo "yes" || echo "no")

            # Check which is tagged as production
            PROD_DIGEST=$(docker manifest inspect "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:production" 2>/dev/null | \
              jq -r '.config.digest // .manifests[0].digest // empty' 2>/dev/null || true)
            BLUE_DIGEST=$(docker manifest inspect "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:blue" 2>/dev/null | \
              jq -r '.config.digest // .manifests[0].digest // empty' 2>/dev/null || true)

            if [ "$PROD_DIGEST" = "$BLUE_DIGEST" ] && [ -n "$PROD_DIGEST" ]; then
              ACTIVE="blue"
              INACTIVE="green"
            else
              ACTIVE="green"
              INACTIVE="blue"
            fi
          fi

          echo "active=$ACTIVE" >> "$GITHUB_OUTPUT"
          echo "inactive=$INACTIVE" >> "$GITHUB_OUTPUT"
          echo "Active slot: $ACTIVE | Deploying to: $INACTIVE"

  deploy-inactive:
    name: Deploy to ${{ needs.preflight.outputs.inactive_slot }}
    runs-on: ubuntu-latest
    needs: preflight

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: bg_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d bg_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/bg_test
      SESSION_SECRET: ci-bg-secret-not-for-production
      NODE_ENV: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      # â”€â”€ DB Migration Compatibility Check â”€â”€
      - name: Wait for Postgres
        if: github.event.inputs.skip_migration_check != 'true'
        run: |
          for i in {1..30}; do pg_isready -h localhost -p 5432 && break || sleep 1; done

      - name: Bootstrap schema
        if: github.event.inputs.skip_migration_check != 'true'
        run: psql "$DATABASE_URL" -f ci/schema.sql

      - name: Run migrations (forward compat check)
        if: github.event.inputs.skip_migration_check != 'true'
        run: node migrations/run-migration.cjs

      - name: Schema compatibility gate
        if: github.event.inputs.skip_migration_check != 'true'
        run: |
          chmod +x tools/schema_compat_check.sh
          bash tools/schema_compat_check.sh

      - name: Migration safety check
        if: github.event.inputs.skip_migration_check != 'true'
        run: |
          chmod +x tools/migration_safety_check.sh
          bash tools/migration_safety_check.sh

      # â”€â”€ Deploy to inactive slot â”€â”€
      - name: Log in to registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME || github.actor }}
          password: ${{ secrets.REGISTRY_PASSWORD || secrets.GITHUB_TOKEN }}

      - name: Tag image for inactive slot
        run: |
          SLOT="${{ needs.preflight.outputs.inactive_slot }}"
          SOURCE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ github.event.inputs.image_digest }}"
          TARGET="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${SLOT}"

          docker pull "$SOURCE"
          docker tag "$SOURCE" "$TARGET"
          docker push "$TARGET"

          echo "âœ… Deployed to $SLOT slot"

          # NOTE: Add your infra-specific deploy command:
          # kubectl set image deployment/app-${SLOT} app=${SOURCE}
          # aws ecs update-service --cluster prod --service app-${SLOT}

      # â”€â”€ Smoke tests against inactive slot â”€â”€
      - name: Smoke tests
        run: |
          SLOT="${{ needs.preflight.outputs.inactive_slot }}"
          TIMEOUT="${{ github.event.inputs.smoke_test_timeout || '120' }}"

          echo "Running smoke tests against $SLOT slot (timeout: ${TIMEOUT}s)..."

          # Run billing parity as smoke test
          timeout "$TIMEOUT" npx vitest run tests/unit/billing.service.test.ts --reporter=verbose || {
            echo "::error::Smoke tests failed on $SLOT slot"
            exit 1
          }
          echo "âœ… Smoke tests passed on $SLOT slot"

  switch-traffic:
    name: Switch Traffic â†’ ${{ needs.preflight.outputs.inactive_slot }}
    runs-on: ubuntu-latest
    needs: [preflight, deploy-inactive]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME || github.actor }}
          password: ${{ secrets.REGISTRY_PASSWORD || secrets.GITHUB_TOKEN }}

      - name: Switch production to new slot
        run: |
          NEW_SLOT="${{ needs.preflight.outputs.inactive_slot }}"
          OLD_SLOT="${{ needs.preflight.outputs.active_slot }}"
          SOURCE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${NEW_SLOT}"
          PROD_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:production"

          # Tag the new slot image as production
          docker pull "$SOURCE"
          docker tag "$SOURCE" "$PROD_TAG"
          docker push "$PROD_TAG"

          echo "âœ… Production traffic switched: $OLD_SLOT â†’ $NEW_SLOT"

          # NOTE: Add your infra-specific traffic switch:
          # kubectl patch service app-production -p '{"spec":{"selector":{"slot":"'$NEW_SLOT'"}}}'
          # aws elbv2 modify-listener --listener-arn $ARN --default-actions Type=forward,TargetGroupArn=$NEW_TG

      - name: Deployment summary
        run: |
          echo "## ðŸ”µðŸŸ¢ Blue/Green Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| **Digest** | \`${{ github.event.inputs.image_digest }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Previous Active** | ${{ needs.preflight.outputs.active_slot }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **New Active** | ${{ needs.preflight.outputs.inactive_slot }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Migrations** | âœ… Compatible |" >> $GITHUB_STEP_SUMMARY
          echo "| **Smoke Tests** | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Rollback**: Re-tag \`${{ needs.preflight.outputs.active_slot }}\` as \`production\`" >> $GITHUB_STEP_SUMMARY
