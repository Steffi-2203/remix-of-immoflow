-- 1. units
CREATE TABLE units (
  id UUID PRIMARY KEY,
  property_id UUID NOT NULL,
  unit_number TEXT,
  area_m2 NUMERIC,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 2. tenants
CREATE TABLE tenants (
  id UUID PRIMARY KEY,
  first_name TEXT,
  last_name TEXT,
  email TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 3. leases
CREATE TABLE leases (
  id UUID PRIMARY KEY,
  tenant_id UUID REFERENCES tenants(id),
  unit_id UUID REFERENCES units(id),
  start_date DATE NOT NULL,
  end_date DATE, -- nullable for open-ended
  rent_cents INT NOT NULL,
  service_charges_cents INT DEFAULT 0,
  deposit_cents INT DEFAULT 0,
  status TEXT NOT NULL DEFAULT 'active', -- active, terminated, closed
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 4. monthly_invoices
CREATE TABLE monthly_invoices (
  id UUID PRIMARY KEY,
  lease_id UUID REFERENCES leases(id),
  year INT NOT NULL,
  month INT NOT NULL,
  gross_cents INT NOT NULL,
  paid_cents INT DEFAULT 0,
  status TEXT NOT NULL DEFAULT 'open', -- open, partial, paid
  version INT DEFAULT 1,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  UNIQUE (lease_id, year, month)
);

-- 5. payments
CREATE TABLE payments (
  id UUID PRIMARY KEY,
  external_id TEXT, -- optional id from bank/webhook
  tenant_id UUID REFERENCES tenants(id),
  amount_cents INT NOT NULL,
  received_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 6. payment_allocations
CREATE TABLE payment_allocations (
  id UUID PRIMARY KEY,
  payment_id UUID REFERENCES payments(id),
  invoice_id UUID REFERENCES monthly_invoices(id),
  applied_cents INT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 7. transactions for overpayment/refunds
CREATE TABLE transactions (
  id UUID PRIMARY KEY,
  tenant_id UUID REFERENCES tenants(id),
  amount_cents INT NOT NULL,
  booking_text TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 8. audit_logs
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY,
  user_id TEXT,
  table_name TEXT,
  record_id UUID,
  action TEXT,
  summary JSONB,
  detail JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);
