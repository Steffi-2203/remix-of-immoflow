// scripts/load-seed.ts
import fs from "fs";
import path from "path";
import { Pool } from "pg";
import { promisify } from "util";

const readFile = promisify(fs.readFile);

async function run() {
  if (!process.env.DATABASE_URL) {
    console.error("DATABASE_URL not set");
    process.exit(1);
  }
  const pool = new Pool({ connectionString: process.env.DATABASE_URL });
  const client = await pool.connect();

  try {
    const seedDir = path.resolve(__dirname, "../seed");
    const files = fs.readdirSync(seedDir).filter(f => f.endsWith(".json"));
    for (const file of files) {
      const content = await readFile(path.join(seedDir, file), "utf8");
      const json = JSON.parse(content);

      // properties
      if (Array.isArray(json.properties)) {
        for (const p of json.properties) {
          await client.query(
            `INSERT INTO properties (id, organization_id, name, address, city, postal_code, created_at)
             VALUES ($1,$2,$3,$4,$5,$6,$7)
             ON CONFLICT (id) DO NOTHING`,
            [p.id, p.organizationId, p.name, p.address, p.city, p.postalCode, p.createdAt || new Date()]
          );
        }
      }

      // units
      if (Array.isArray(json.units)) {
        for (const u of json.units) {
          await client.query(
            `INSERT INTO units (id, property_id, top_nummer, type, flaeche, created_at)
             VALUES ($1,$2,$3,$4,$5,$6)
             ON CONFLICT (id) DO NOTHING`,
            [u.id, u.propertyId, u.topNummer, u.type, u.flaeche, u.createdAt || new Date()]
          );
        }
      }

      // tenants
      if (Array.isArray(json.tenants)) {
        for (const t of json.tenants) {
          await client.query(
            `INSERT INTO tenants (id, unit_id, first_name, last_name, grundmiete, betriebskosten_vorschuss, heizkosten_vorschuss, status, created_at)
             VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9)
             ON CONFLICT (id) DO NOTHING`,
            [t.id, t.unitId, t.firstName, t.lastName, t.grundmiete, t.betriebskostenVorschuss || t.betriebskosten_vorschuss, t.heizkostenVorschuss || t.heizkosten_vorschuss, t.status || "aktiv", t.createdAt || new Date()]
          );
        }
      }

      // monthly_invoices
      if (Array.isArray(json.monthly_invoices)) {
        for (const inv of json.monthly_invoices) {
          await client.query(
            `INSERT INTO monthly_invoices (id, tenant_id, unit_id, year, month, grundmiete, betriebskosten, heizungskosten, gesamtbetrag, status, created_at)
             VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11)
             ON CONFLICT (id) DO NOTHING`,
            [inv.id, inv.tenantId, inv.unitId, inv.year, inv.month, inv.grundmiete, inv.betriebskosten, inv.heizungskosten, inv.gesamtbetrag, inv.status || "offen", inv.createdAt || new Date()]
          );
        }
      }

      console.log(`Loaded ${file}`);
    }

    console.log("Seed load complete");
  } catch (err) {
    console.error("Seed load failed", err);
  } finally {
    client.release();
    await pool.end();
  }
}

run();
