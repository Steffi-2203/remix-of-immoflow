import { db } from "./db";
import { sql, eq, and } from "drizzle-orm";
import {
  organizations,
  profiles,
  userRoles,
  userOrganizations,
} from "../shared/schema";

export async function runSeed() {
  console.log("üîµ [SEED] Starte Seed-Prozess‚Ä¶");

  try {
    // ---------------------------------------------------------
    // 1. ORGANIZATION
    // ---------------------------------------------------------
    const orgName = "ImmoFlowMe";
    const existingOrg = await db.query.organizations.findFirst({
      where: eq(organizations.name, orgName),
    });

    let orgId: string;

    if (existingOrg) {
      console.log("‚úîÔ∏è [SEED] Organisation existiert bereits:", existingOrg.id);
      orgId = existingOrg.id;
    } else {
      console.log("üü° [SEED] Erstelle Organisation‚Ä¶");

      const inserted = await db
        .insert(organizations)
        .values({
          name: orgName,
          subscriptionTier: sql`'professional'::subscription_tier`,
          subscriptionStatus: sql`'active'::subscription_status`,
        })
        .returning();

      orgId = inserted[0].id;
      console.log("‚úîÔ∏è [SEED] Organisation erstellt:", orgId);
    }

    // ---------------------------------------------------------
    // 2. PROFILE (ADMIN)
    // ---------------------------------------------------------
    const adminEmail = "admin@immoflowme.at";

    const existingProfile = await db.query.profiles.findFirst({
      where: eq(profiles.email, adminEmail),
    });

    let adminId: string;

    if (existingProfile) {
      console.log("‚úîÔ∏è [SEED] Admin-Profil existiert bereits:", existingProfile.id);
      adminId = existingProfile.id;
    } else {
      console.log("üü° [SEED] Erstelle Admin-Profil‚Ä¶");

      const inserted = await db
        .insert(profiles)
        .values({
          email: adminEmail,
          fullName: "System Administrator",
          subscriptionTier: sql`'pro'::user_subscription_tier`, // WICHTIG!
        })
        .onConflictDoNothing() // profiles.email ist UNIQUE
        .returning();

      if (inserted.length === 0) {
        throw new Error("‚ùå [SEED] Admin-Profil konnte nicht erstellt werden.");
      }

      adminId = inserted[0].id;
      console.log("‚úîÔ∏è [SEED] Admin-Profil erstellt:", adminId);
    }

    // ---------------------------------------------------------
    // 3. ROLE (ADMIN)
    // ---------------------------------------------------------
    const existingRole = await db.query.userRoles.findFirst({
      where: and(eq(userRoles.userId, adminId), eq(userRoles.role, "admin")),
    });

    if (existingRole) {
      console.log("‚úîÔ∏è [SEED] Admin-Rolle existiert bereits.");
    } else {
      console.log("üü° [SEED] Erstelle Admin-Rolle‚Ä¶");

      await db.insert(userRoles).values({
        userId: adminId,
        role: sql`'admin'::app_role`,
      });

      console.log("‚úîÔ∏è [SEED] Admin-Rolle erstellt.");
    }

    // ---------------------------------------------------------
    // 4. MEMBERSHIP (ADMIN ‚Üî ORG)
    // ---------------------------------------------------------
    const existingMembership = await db.query.userOrganizations.findFirst({
      where: and(
        eq(userOrganizations.userId, adminId),
        eq(userOrganizations.organizationId, orgId)
      ),
    });

    if (existingMembership) {
      console.log("‚úîÔ∏è [SEED] Mitgliedschaft existiert bereits.");
    } else {
      console.log("üü° [SEED] Erstelle Mitgliedschaft‚Ä¶");

      await db
        .insert(userOrganizations)
        .values({
          userId: adminId,
          organizationId: orgId,
        })
        .onConflictDoNothing(); // UNIQUE(userId, organizationId)

      console.log("‚úîÔ∏è [SEED] Mitgliedschaft erstellt.");
    }

    console.log("üü¢ [SEED] Seed-Prozess erfolgreich abgeschlossen.");
  } catch (err) {
    console.error("‚ùå [SEED] Fehler im Seed-Prozess:", err);
    throw err; // WICHTIG: Server darf NICHT starten, wenn Seed scheitert
  }
}
