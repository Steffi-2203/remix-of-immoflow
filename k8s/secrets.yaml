# Kubernetes Secrets Management
#
# Uses external-secrets-operator to sync secrets from Vault/AWS KMS/GCP SM.
# Secrets are short-lived and auto-rotated.
#
# kubectl apply -f k8s/secrets.yaml

# ── ExternalSecret: pulls from Vault/AWS SM ──
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: immoflowme-secrets
  labels:
    app: immoflowme
spec:
  refreshInterval: 5m  # short-lived: refresh every 5 minutes
  secretStoreRef:
    name: vault-backend  # or aws-secretsmanager, gcp-sm
    kind: ClusterSecretStore
  target:
    name: immoflowme-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app: immoflowme
  data:
    # Database credentials (short-lived via Vault database engine)
    - secretKey: DATABASE_URL
      remoteRef:
        key: immoflowme/production/database
        property: url

    - secretKey: SESSION_SECRET
      remoteRef:
        key: immoflowme/production/session
        property: secret

    # Stripe
    - secretKey: STRIPE_SECRET_KEY
      remoteRef:
        key: immoflowme/production/stripe
        property: secret_key

    - secretKey: STRIPE_WEBHOOK_SECRET
      remoteRef:
        key: immoflowme/production/stripe
        property: webhook_secret

    # Resend
    - secretKey: RESEND_API_KEY
      remoteRef:
        key: immoflowme/production/resend
        property: api_key

    # OpenAI
    - secretKey: OPENAI_API_KEY
      remoteRef:
        key: immoflowme/production/openai
        property: api_key

    # Internal
    - secretKey: INTERNAL_CRON_SECRET
      remoteRef:
        key: immoflowme/production/internal
        property: cron_secret

---
# ── SecretStore: Vault configuration ──
# Uncomment and configure for your Vault instance
#
# apiVersion: external-secrets.io/v1beta1
# kind: ClusterSecretStore
# metadata:
#   name: vault-backend
# spec:
#   provider:
#     vault:
#       server: https://vault.internal:8200
#       path: secret
#       version: v2
#       auth:
#         kubernetes:
#           mountPath: kubernetes
#           role: immoflowme
#           serviceAccountRef:
#             name: immoflowme-sa

---
# ── SecretProviderClass: CSI driver alternative (mounts secrets as files) ──
# Use this if you prefer file-based secrets over env vars.
# Avoids secrets appearing in `kubectl describe pod` or process listings.
#
# apiVersion: secrets-store.csi.x-k8s.io/v1
# kind: SecretProviderClass
# metadata:
#   name: immoflowme-vault
# spec:
#   provider: vault
#   parameters:
#     vaultAddress: https://vault.internal:8200
#     roleName: immoflowme
#     objects: |
#       - objectName: "database-url"
#         secretPath: "secret/data/immoflowme/production/database"
#         secretKey: "url"
#       - objectName: "session-secret"
#         secretPath: "secret/data/immoflowme/production/session"
#         secretKey: "secret"
