# Kubernetes Runtime Hardening — ImmoflowMe
#
# kubectl apply -f k8s/

apiVersion: apps/v1
kind: Deployment
metadata:
  name: immoflowme
  labels:
    app: immoflowme
    version: stable
spec:
  replicas: 3
  selector:
    matchLabels:
      app: immoflowme
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        app: immoflowme
        version: stable
    spec:
      serviceAccountName: immoflowme-sa
      automountServiceAccountToken: false
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        runAsGroup: 1001
        fsGroup: 1001
        seccompProfile:
          type: RuntimeDefault

      # ── Anti-affinity: spread across nodes ──
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values: [immoflowme]
                topologyKey: kubernetes.io/hostname

      containers:
        - name: app
          image: ghcr.io/org/immoflowme:production  # replaced by CI/CD
          imagePullPolicy: Always

          ports:
            - containerPort: 3000
              name: http
              protocol: TCP

          # ── Resource limits & requests ──
          resources:
            requests:
              cpu: 250m
              memory: 256Mi
            limits:
              cpu: '1'
              memory: 512Mi

          # ── Probes tuned to realistic startup ──
          startupProbe:
            httpGet:
              path: /api/health
              port: http
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 12  # 60s max startup

          readinessProbe:
            httpGet:
              path: /api/health
              port: http
            initialDelaySeconds: 0
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3
            successThreshold: 1

          livenessProbe:
            httpGet:
              path: /api/health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 15
            timeoutSeconds: 5
            failureThreshold: 3

          # ── Environment (secrets from Vault/KMS, not plaintext) ──
          env:
            - name: NODE_ENV
              value: production
            - name: PORT
              value: '3000'
          envFrom:
            - secretRef:
                name: immoflowme-secrets  # managed by external-secrets or sealed-secrets

          # ── Security context ──
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: [ALL]

          volumeMounts:
            - name: tmp
              mountPath: /tmp

      volumes:
        - name: tmp
          emptyDir:
            sizeLimit: 100Mi

---
# ── Minimal ServiceAccount ──
apiVersion: v1
kind: ServiceAccount
metadata:
  name: immoflowme-sa
  labels:
    app: immoflowme
automountServiceAccountToken: false

---
# ── HPA: scale on CPU + custom metrics ──
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: immoflowme-hpa
  labels:
    app: immoflowme
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: immoflowme
  minReplicas: 3
  maxReplicas: 15
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Pods
          value: 2
          periodSeconds: 60
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Pods
          value: 1
          periodSeconds: 120
  metrics:
    # CPU-based scaling
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    # Memory-based scaling
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
    # Custom: request latency p99 (requires prometheus-adapter)
    - type: Pods
      pods:
        metric:
          name: http_request_duration_seconds_p99
        target:
          type: AverageValue
          averageValue: '1.5'
    # Custom: job queue length (requires prometheus-adapter)
    - type: Object
      object:
        metric:
          name: job_queue_pending_total
        describedObject:
          apiVersion: v1
          kind: Service
          name: immoflowme
        target:
          type: Value
          value: '50'

---
# ── PodDisruptionBudget ──
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: immoflowme-pdb
  labels:
    app: immoflowme
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: immoflowme

---
# ── NetworkPolicy: least privilege ──
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: immoflowme-netpol
  labels:
    app: immoflowme
spec:
  podSelector:
    matchLabels:
      app: immoflowme
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow traffic from ingress controller only
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: ingress-nginx
      ports:
        - protocol: TCP
          port: 3000
    # Allow traffic from monitoring (Prometheus scrape)
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - protocol: TCP
          port: 3000
  egress:
    # Allow DNS
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    # Allow PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app: postgresql
      ports:
        - protocol: TCP
          port: 5432
    # Allow external HTTPS (Stripe, Resend, OpenAI, etc.)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - protocol: TCP
          port: 443

---
# ── Service ──
apiVersion: v1
kind: Service
metadata:
  name: immoflowme
  labels:
    app: immoflowme
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app: immoflowme
