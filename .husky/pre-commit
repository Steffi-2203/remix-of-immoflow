#!/bin/sh

# ── Block reconciliation artifacts ──
BLOCKED_FILES="dryrun.json db_lines.json invoice_lines_run.json missing_lines.csv missing_lines.json dry_db_diffs.json"

for file in $BLOCKED_FILES; do
  if git diff --cached --name-only | grep -qx "$file"; then
    echo "ERROR: Reconciliation artifact '$file' is staged for commit."
    echo "These files should not be committed. Remove with: git reset HEAD $file"
    exit 1
  fi
done

# ── Block CSV files anywhere in the repo ──
CSV_FILES=$(git diff --cached --name-only | grep -i '\.csv$' || true)
if [ -n "$CSV_FILES" ]; then
  echo "ERROR: CSV files must not be committed to the repository."
  echo "Blocked files:"
  echo "$CSV_FILES"
  echo ""
  echo "Store full CSVs in the secure artifact store (S3/GCS), not in Git."
  echo "Only summary.json + SHA256 hashes belong in the repo."
  exit 1
fi

# ── Block reconciliation directories ──
RECON_DIRS=$(git diff --cached --name-only | grep -E '^(reconciliations|ci-artifacts)/' || true)
if [ -n "$RECON_DIRS" ]; then
  echo "ERROR: Reconciliation/artifact directories must not be committed."
  echo "Blocked paths:"
  echo "$RECON_DIRS"
  exit 1
fi

# ── git-secrets scan (if installed) ──
if command -v git-secrets >/dev/null 2>&1; then
  git secrets --pre_commit_hook -- "$@"
else
  # Fallback: scan for common secret patterns
  SECRETS_FOUND=$(git diff --cached -U0 | grep -iE '(PRIVATE_KEY|SECRET_KEY|password\s*=\s*["\x27][^"\x27]+|sk_live_|rk_live_|-----BEGIN (RSA|EC|OPENSSH) PRIVATE KEY)' || true)
  if [ -n "$SECRETS_FOUND" ]; then
    echo "ERROR: Potential secrets detected in staged changes!"
    echo "Install git-secrets for comprehensive scanning: brew install git-secrets"
    echo ""
    echo "Matches found:"
    echo "$SECRETS_FOUND" | head -5
    exit 1
  fi
fi

# ── generate-summary (if available) ──
if [ -f tools/generate-summary.js ]; then
  node tools/generate-summary.js 2>/dev/null || true
fi
